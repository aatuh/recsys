FROM golang:1.25.7-alpine AS builder

WORKDIR /src

RUN apk add --no-cache ca-certificates git tzdata

# Copy module manifests first for better layer caching.
COPY api/go.mod api/go.sum /src/api/
COPY recsys-algo/go.mod recsys-algo/go.sum /src/recsys-algo/

WORKDIR /src/api
RUN go mod download

# Copy source trees referenced by the local replace in api/go.mod.
COPY api/. /src/api/
COPY recsys-algo/. /src/recsys-algo/

ARG VERSION=dev
ARG COMMIT=none
ARG DATE=unknown
ARG TARGETOS=linux
ARG TARGETARCH

ENV CGO_ENABLED=0

RUN GOOS=$TARGETOS GOARCH=${TARGETARCH:-$(go env GOARCH)} \
	go build -trimpath \
	-ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}" \
	-o /out/recsys-service \
	./cmd/recsys-service

FROM alpine:3.21

RUN apk add --no-cache ca-certificates tzdata \
	&& addgroup -S app \
	&& adduser -S app -G app \
	&& mkdir -p /tmp \
	&& chown app:app /tmp

WORKDIR /app

COPY --from=builder /out/recsys-service /app/recsys-service

EXPOSE 8000

USER app

ENV TMPDIR=/tmp

HEALTHCHECK --interval=30s --timeout=3s --retries=3 CMD wget -qO- http://127.0.0.1:8000/healthz >/dev/null 2>&1 || exit 1

ENTRYPOINT ["/app/recsys-service"]
