services:
  db:
    container_name: recsys-db
    image: postgres:16
    ports: ["${POSTGRES_PORT:-5432}:5432"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-recsys-db}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-recsys}
      POSTGRES_DB: ${POSTGRES_DB:-recsys-db}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - db_data:/var/lib/postgresql/data

  api:
    container_name: recsys-svc
    build:
      context: ./api
      dockerfile: ./Dockerfile.dev
    depends_on:
      db: { condition: service_healthy }
    environment:
      - VERSION=${VERSION:-dev}
      - COMMIT=${COMMIT:-none}
      - DATE=${DATE:-unknown}
    env_file:
      - ./api/.env
    ports:
      - "${API_PORT:-8000}:8000"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./api:/app
      - api_tmp:/app/tmp
      - api_bin:/app/bin
      - api_coverage:/app/.coverage
      - api_test_cache:/app/.test-cache
      - api_pkg:/go/pkg/mod
      - api_sumdb:/go/pkg/sumdb
      - api_gocache:/root/.cache/go-build
    init: true
    stop_signal: SIGINT
    stop_grace_period: 1s
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:${API_PORT:-8000}/healthz || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: >-
      sh -c '
        reflex -r "\\.(go|sql)$" -s -- sh -c "make build-bin && ./bin/recsys-service"
      '

  test:
    container_name: recsys-test
    build:
      context: ./api
      dockerfile: ./Dockerfile.dev
    environment:
      - GOCACHE=/root/.cache/go-build
      - GOMODCACHE=/go/pkg/mod
    env_file:
      - api/.env.test
    volumes:
      - ./api:/app
      - test_tmp:/app/tmp
      - test_bin:/app/bin
      - test_coverage:/app/.coverage
      - test_test_cache:/app/.test-cache
      - test_pkg:/go/pkg/mod
      - test_sumdb:/go/pkg/sumdb
      - test_gocache:/root/.cache/go-build
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
    command: ["sh", "-c", "/app/scripts/test.sh"]
    profiles: ["test"]

  adminer:
    container_name: recsys-adminer
    image: adminer:latest
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    depends_on:
      - db
    environment:
      ADMINER_DEFAULT_SERVER: db

  minio:
    container_name: recsys-minio
    image: minio/minio:RELEASE.2024-10-13T13-34-11Z
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:9000/minio/health/ready || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  minio-init:
    container_name: recsys-minio-init
    image: minio/mc:RELEASE.2024-10-02T08-27-28Z
    depends_on:
      - minio
    entrypoint: >-
      /bin/sh -c "
      until mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin}; do
        sleep 1;
      done;
      mc mb -p local/${MINIO_BUCKET:-recsys-artifacts} || true;
      mc anonymous set download local/${MINIO_BUCKET:-recsys-artifacts} || true;
      "

volumes:
  db_data:
  api_tmp:
  api_bin:
  api_coverage:
  api_test_cache:
  api_pkg:
  api_sumdb:
  api_gocache:
  test_tmp:
  test_bin:
  test_coverage:
  test_test_cache:
  test_pkg:
  test_sumdb:
  test_gocache:
  minio_data:
